# 비밀번호 동기화 문제 해결 보고서

**작성일**: 2026-01-13  
**프로젝트**: Family Mission Manager  
**이슈**: PC에서 변경한 비밀번호가 모바일에 즉시 반영되지 않는 문제

---

## 📋 목차

1. [문제 정의](#1-문제-정의)
2. [원인 분석](#2-원인-분석)
3. [해결 방안](#3-해결-방안)
4. [실패 경험 (2026-01-12)](#4-실패-경험-2026-01-12)
5. [성공 요인 (2026-01-13)](#5-성공-요인-2026-01-13)
6. [기술적 구현 세부사항](#6-기술적-구현-세부사항)
7. [향후 참고사항](#7-향후-참고사항)

---

## 1. 문제 정의

### 증상

- PC의 Settings 페이지에서 비밀번호 변경
- 변경 완료 메시지 표시
- **모바일에서 구 비밀번호로만 로그인 가능**
- 새 비밀번호로 로그인 시도 시 실패

### 영향

- 사용자 경험 저하
- 비밀번호 변경 기능 사실상 무용지물
- 앱 재시작(Reboot)이 필요한 심각한 UX 문제

---

## 2. 원인 분석

### 근본 원인

**Streamlit Cloud의 파일 시스템이 읽기 전용(Read-only)**

```
[Errno 30] Read-only file system: '.streamlit/secrets.toml'
```

### 기술적 배경

#### 기존 방식 (파일 기반)

```python
# modules/auth_utils.py (구버전)
def change_password(username, new_password):
    # secrets.toml 파일에 쓰기 시도
    with open('.streamlit/secrets.toml', 'w') as f:
        toml.dump(config, f)  # ❌ Streamlit Cloud에서 불가능
```

#### Streamlit Cloud의 제약

- 보안상의 이유로 파일 시스템이 **읽기 전용**
- `secrets.toml`은 대시보드에서만 수정 가능
- 앱 코드 내에서 파일 쓰기 불가

---

## 3. 해결 방안

### 선택한 방법: DB 기반 인증 시스템

**Google Sheets를 사용자 DB로 활용**

```mermaid
graph LR
    A[Settings 페이지] --> B[change_password]
    B --> C[db_manager.update_user_password]
    C --> D[Google Sheets 'Users' 시트]
    D --> E[모든 기기에 즉시 반영]
```

### 대안 검토

| 방법                | 장점                     | 단점                 | 선택 여부 |
| ------------------- | ------------------------ | -------------------- | --------- |
| 파일 기반 유지      | 빠름, 간단               | **Cloud에서 불가능** | ❌        |
| 환경 변수 (Secrets) | Cloud 대시보드 지원      | 앱 내부 변경 불가    | ❌        |
| **Google Sheets**   | 실시간 동기화, 구현 가능 | API 호출 비용        | ✅        |
| PostgreSQL          | 전문 DB, 빠름            | 인프라 비용, 복잡도  | ❌        |

---

## 4. 실패 경험 (2026-01-12)

### 시도 내용

- 약 2시간 동안 DB 기반 인증 구현 시도
- 6개 파일 동시 수정
- 여러 기능 한 번에 추가

### 실패 원인

#### 1. UI 상태 관리 오류

```python
# 문제: selectbox가 이전 값 기억
sel_stamp = st.selectbox("도장", options)
# ❌ key 파라미터 없음 → Session State 유지
```

#### 2. 검증 부재

- 코드 수정했으나 **사용자에게 보이는 증거 없음**
- "믿어주세요" 방식 → 신뢰 상실

#### 3. 앱 재시작 미안내

- 코드 수정 후 **Reboot 필요성을 명시하지 않음**
- 사용자는 단순 새로고침만 함

### 결과

- **완전 롤백**
- 사용자: "2시간 헛수고"
- 신뢰도 하락

---

## 5. 성공 요인 (2026-01-13)

### 전략 변경

#### Phase 1: DB 읽기만 먼저 구현 (30분)

```python
# db_manager.py
def get_user_dict(self):
    users_df = self.get_data("Users", ttl=0)
    # ... streamlit-authenticator 호환 형식 반환
```

**검증**: 로그인 성공 확인 → ✅

#### Phase 2: DB 쓰기 추가 (30분)

```python
# db_manager.py
def update_user_password(self, username, new_hash):
    users_df = self.get_data("Users", ttl=0)
    # ... 비밀번호 업데이트
    return self.update_data("Users", users_df)
```

**검증**: PC에서 변경 → 새 비밀번호로 재로그인 → ✅

#### Phase 3: 모바일 검증 (10분)

**검증**: 모바일에서 새 비밀번호 로그인 → ✅

### 핵심 차이점

| 어제 (실패)           | 오늘 (성공)                       |
| --------------------- | --------------------------------- |
| 한 번에 6개 파일 수정 | **단계별 수정** (Phase 1 → 2 → 3) |
| 검증 없이 진행        | **매 Phase마다 검증**             |
| 사용자 확인 없음      | **사용자 OK 후 다음 단계**        |
| 에러 발생 위치 불명   | **DEBUG 로깅**으로 정확한 진단    |
| Git push 누락         | **매 Phase마다 Git push**         |

---

## 6. 기술적 구현 세부사항

### 파일 구조

```
modules/
├── db_manager.py          # get_user_dict(), update_user_password() 추가
├── auth_utils.py          # DB 조회/업데이트로 변경
└── time_utils.py          # KST 강제 (새로 생성)

pages/
└── 6_⚙️_Settings.py      # DB 기반 비밀번호 변경

migrate_users_phase1.py    # 데이터 이관 스크립트
```

### 코드 예시

#### 1. 사용자 정보 읽기

```python
# modules/db_manager.py
def get_user_dict(self):
    users_df = self.get_data("Users", ttl=0)  # 캐시 끔

    usernames_dict = {}
    for _, row in users_df.iterrows():
        username = row.get("username", "")
        usernames_dict[username] = {
            "name": row.get("name", username),
            "password": row.get("password", ""),
            "email": row.get("email", ""),
            "role": row.get("role", "user")
        }

    return {"usernames": usernames_dict}
```

#### 2. 비밀번호 업데이트

```python
# modules/db_manager.py
def update_user_password(self, username, new_password_hash):
    users_df = self.get_data("Users", ttl=0)

    if username in users_df['username'].values:
        idx = users_df[users_df['username'] == username].index[0]
        users_df.at[idx, 'password'] = new_password_hash
        users_df.at[idx, 'updated_at'] = time_utils.get_current_time_str()

        return self.update_data("Users", users_df)

    return False
```

#### 3. 인증 설정 조회

```python
# modules/auth_utils.py
def get_auth_config():
    # DB에서 사용자 정보 가져오기
    credentials = db_manager.get_user_dict()

    # 쿠키 설정은 st.secrets에서
    cookie_config = {
        "expiry_days": st.secrets.get("auth", {}).get("cookie_expiry_days", 30),
        "key": st.secrets.get("auth", {}).get("cookie_key", "random_signature_key"),
        "name": st.secrets.get("auth", {}).get("cookie_name", "family_app_cookie")
    }

    return {
        "credentials": credentials,
        "cookie": cookie_config
    }
```

#### 4. 비밀번호 변경

```python
# modules/auth_utils.py
def change_password(username, new_password_plain):
    try:
        # 1. Hash Password
        hashed_pw = bcrypt.hashpw(
            new_password_plain.encode('utf-8'),
            bcrypt.gensalt()
        ).decode('utf-8')

        # 2. Update Database
        if db_manager.update_user_password(username, hashed_pw):
            return True, "비밀번호가 변경되었습니다. (모든 기기에 즉시 적용됨)"
        else:
            return False, "사용자를 찾을 수 없습니다."

    except Exception as e:
        return False, f"오류 발생: {e}"
```

### Google Sheets 스키마

**시트명**: Users

| 컬럼명     | 타입   | 설명           | 예시                  |
| ---------- | ------ | -------------- | --------------------- |
| username   | string | 사용자 ID (PK) | `dad`, `son1`         |
| password   | string | bcrypt 해시    | `$2b$12$...`          |
| name       | string | 표시 이름      | `아빠`, `큰보물`      |
| email      | string | 이메일         | `user@example.com`    |
| role       | string | 역할           | `admin`, `user`       |
| updated_at | string | 최종 수정 시각 | `2026-01-13 22:00:00` |

---

## 7. 향후 참고사항

### Streamlit Cloud 환경 특성

#### 1. 파일 시스템 = 읽기 전용

```python
# ❌ 절대 불가능
with open('any_file.txt', 'w') as f:
    f.write('data')

# ✅ 가능
data = open('any_file.txt', 'r').read()
```

#### 2. Git Push 필수

로컬 수정 → Cloud 반영 흐름:

```bash
# 1. 로컬 수정
vim modules/auth_utils.py

# 2. Git commit & push (필수!)
git add modules/auth_utils.py
git commit -m "Fix auth"
git push origin main

# 3. Streamlit Cloud 자동 재배포 (1~2분)
```

**주의**: Git push 없이 아무리 로컬에서 수정해도 Cloud에는 반영 안 됨!

#### 3. Python 캐싱

```bash
# __pycache__ 삭제 필요
Get-ChildItem -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force
```

### 단계별 검증 체크리스트

**Phase 1 체크리스트**:

- [ ] DB 읽기 메서드 구현
- [ ] Git commit & push
- [ ] Cloud 재배포 확인 (1~2분 대기)
- [ ] 로그인 테스트
- [ ] **성공 확인 후 다음 Phase**

**Phase 2 체크리스트**:

- [ ] DB 쓰기 메서드 구현
- [ ] Git commit & push
- [ ] Cloud 재배포 확인
- [ ] PC에서 비밀번호 변경
- [ ] PC에서 새 비밀번호로 재로그인
- [ ] **성공 확인 후 다음 Phase**

**Phase 3 체크리스트**:

- [ ] 모바일 브라우저로 접속
- [ ] 새 비밀번호로 로그인
- [ ] **성공 → 완료!**

### DEBUG 로깅 패턴

개발 중에는 상세 로그 추가:

```python
def critical_function():
    st.write("[DEBUG] Step 1: ...")
    result = some_operation()
    st.write(f"[DEBUG] Result: {result}")
```

프로덕션 배포 전 제거:

```python
def critical_function():
    result = some_operation()
    return result
```

### 롤백 준비

각 Phase마다 Git commit 생성:

```bash
git commit -m "Phase 1: DB read"     # 여기로 롤백 가능
git commit -m "Phase 2: DB write"    # 여기로 롤백 가능
git commit -m "Phase 3: Verified"    # 최종
```

실패 시:

```bash
git revert HEAD              # 최근 commit 되돌리기
git push origin main
```

---

## 📊 성과 요약

### 해결 완료

- ✅ PC → 모바일 비밀번호 실시간 동기화
- ✅ Settings 탭 상태 유지 (bonus)
- ✅ 오전 미션 생성 문제 (KST 강제)

### 소요 시간

- **어제 (실패)**: 2시간 → 롤백
- **오늘 (성공)**: 1.5시간 → 완료

### 배운 교훈

> **"복잡하면 망한다. 단순하게 쪼개고(Divide), 매 단계 검증하고(Verify), 보여줘라(Show)."**

---

**End of Report**
